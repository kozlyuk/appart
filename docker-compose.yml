version: '3.8'
services:
############
# POSTGRES #
############
  db:
    image: postgres:12-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    env_file:
      - ./.env.db
###########
# BACKEND #
###########
  appart-back:
    build:
      context: .
    image: appart/back:v1
    command: ['gunicorn', '--bind', '0.0.0.0:8000', 'appart.wsgi:application',
              '--worker-tmp-dir', '/dev/shm', '--workers', '2',
              '--threads', '4', '--worker-class', 'gthread']
    ports:
      - 8000:8000
    env_file:
      - ./.env.dev
    depends_on:
      - db
############
# FRONTEND #
############
  appart-front:
    build:
      context: ./appart-frontend
    image: appart/front:v1
    command: [nginx, '-g', 'daemon off;']
    ports:
      - 8080:80
    depends_on:
      - appart-back
#########
# REDIS #
#########
  redis:
    image: "redis:alpine"
##########
# CELERY #
##########
  celery:
    build:
      context: .
    image: appart/celery:v1
    command: ['celery', '-A', 'appart', 'worker', '-l', 'info']
    env_file:
      - ./.env.dev
    depends_on:
      - db
      - redis
###############
# CELERY BEAT #
###############
  celery-beat:
    build:
      context: .
    image: appart/celery-beat:v1
    command: ['celery', '-A', 'appart', 'beat', '-l', 'info']
    env_file:
      - ./.env.dev
    depends_on:
      - db
      - redis

volumes:
  postgres_data:
